name: AI Validation Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test to run'
        required: true
        default: 'ai-comparison'
        type: choice
        options:
          - ai-comparison
          - all-ai-tests

jobs:
  ai-validation:
    name: AI vs Algorithm Comparison
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Allow 1 hour for throttled execution

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run AI Comparison Test
        env:
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        run: |
          echo "Checking if secret is set..."
          if [ -z "$VITE_GEMINI_API_KEY" ]; then
            echo "ERROR: VITE_GEMINI_API_KEY secret is not set!"
            exit 1
          fi
          echo "Secret is set (length: ${#VITE_GEMINI_API_KEY})"

          if [ "${{ github.event.inputs.test_type }}" = "all-ai-tests" ]; then
            pnpm test -- --run src/__tests__/validation/aiVsAlgorithm.test.ts src/__tests__/**/ai*.test.ts --reporter=verbose
          else
            pnpm test -- --run src/__tests__/validation/aiVsAlgorithm.test.ts --reporter=verbose
          fi

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-comparison-results
          path: src/data/ai_comparison_results.json
          retention-days: 90

      - name: Post summary to job
        if: always()
        run: |
          if [ -f src/data/ai_comparison_results.json ]; then
            echo "## AI vs Algorithm Comparison Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat src/data/ai_comparison_results.json | jq '.summary' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## Warning: No results file generated" >> $GITHUB_STEP_SUMMARY
          fi
